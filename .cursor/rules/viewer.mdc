---
description: Writing the viewer/inspector/trajectory viewer
globs:
alwaysApply: false
---

You are building a trajectory viewer for an AI agent benchmark that pits
two AI agent in a round-based game against each other.

## Framework notes

* Write a python server using flask
* As much output as possible should be formatted uses jinja templates
* JS should be kept to a minimum
* Your input is a game folder (described below)
* Use clean modern CSS, but don't go too crazy, simplicity is key
* CSS and JS should be in separate static files, not inline in templates
* **NEVER use inline JavaScript in HTML templates** - all JavaScript must be in separate .js files in the static/js directory
* Organize JavaScript into logical modules: clipboard.js, experiment.js, readme.js, json-editors.js, etc.
* The application consists of two main pages: the viewer and the game picker

## Input folder

The input folders are all subfolders of `logs/`

The input folder has the following files

* metadata.json
* tournament.log
* rounds/$i/sim_$j.log, where $i is the round and $j is the simulation number (repetition of game)
* players/$player_id/$player_id_r$i.traj.json, where $j is the round number
* players/$player_id/player.log
* Trajectory files do not exist for the last round

Here's how a `.traj.log` file looks:


```
{
  "info": {
    "exit_status": null,
    "submission": null,
    "memory": null,
    "model_stats": {
      "instance_cost": 0.0661002,
      "api_calls": 11
    }
  },
  "messages": [
    {
      "role": "system",
      "content": "You are a helpful assistant that can interact with a computer.\n\nYour response must contain exactly ONE bash code block with ONE command (or commands connected with && or ||).\nInclude a THOUGHT section before your command where you explain your reasoning process.\nFormat your response as shown in <format_example>.\n\n<format_example>\nYour reasoning and analysis here. Explain why you want to perform the action.\n\n```bash\nyour_command_here\n```\n</format_example>\n\nFailure to follow these rules will cause your response to be rejected.\nTo finish, issue the following command: `echo MINI_SWE_AGENT_FINAL_OUTPUT`\nwithout any other command."
    },
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "Please solve this issue: in gitconfig, add a new alias ldc which copies the last diff ..."
        }
      ]
    },
    {
      "role": "assistant",
      "content": "THOUGHT: I need to first look at the current directory to see the gitconfig file and understand its structure. Then I'll examine the existing aliases to understand the pattern and add the new 'ldc' alias that combines 'ld' (last diff) with clipboard functionality.\n\n```bash\nls -la\n```"
    },
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "<returncode>0</returncode>\n<output>\ntotal 1232\ndrwxr-xr-x  ..."
        }
      ]
    },
    {
      "role": "assistant",
      "content": "THOUGHT: I can see there's a `gitconfig.sh` file in the current directory. Let me examine its contents to understand the current structure and find the existing aliases, particularly looking for the 'ld' alias and any clipboard-related aliases that I need to combine.\n\n```bash\ncat gitconfig.sh\n```"
    },
  "trajectory_format": "mini-swe-agent-1"
}
```

Here's how the metadata.json file looks like:

```
{
  "name": "PvpTournament",
  "tournament_id": "PvpTournament.BattleSnake.250915203207",
  "config": {
    "tournament": {
      "rounds": 10
    },
    "game": {
      "name": "BattleSnake",
      "sims_per_round": 1000,
      "args": {
        "width": 11,
        "height": 11,
        "browser": false
      }
    },
    "players": [
      {
        "agent": "mini",
        "name": "sonnet-4-more-prescriptive",
        "config": {
          "agent": {
            "system_template": "",
            "instance_template": "",
            "step_limit": 30,
            "cost_limit": 1.0
          },
          "model": {
            "model_name": "openai/gpt-5-mini"
          }
        }
      },
      {
        "agent": "mini",
        "name": "gpt-5-mini-default",
        "config": {
          "agent": {...},
          "model": {
            "model_name": "openai/gpt-5-mini"
          }
        }
      }
    ],
    "prompts": {
      "game_description": "..."}
  },
  "created_timestamp": 1757982727,
  "game": {
    "name": "BattleSnake",
    "config": {
      "name": "BattleSnake",
      "sims_per_round": 1000,
      "args": {
        "width": 11,
        "height": 11,
        "browser": false
      }
    },
    "game_id": "PvpTournament.BattleSnake.250915203207",
    "created_timestamp": 1757982727
  },
  "agents": [
    {
      "name": "sonnet-4-more-prescriptive",
      "player_unique_id": "38f5a945-2a14-4cfb-9a41-e3ccceb7d3e2",
      "created_timestamp": 1757982729,
      "config": {
        "agent": "mini",
        "name": "sonnet-4-more-prescriptive",
        "config": {
          "agent": {
            "system_template": "...,
            "instance_template": "...",
            "step_limit": 30,
            "cost_limit": 1.0
          },
          "model": {
            "model_name": "openai/gpt-5-mini"
          }
        }
      },
      "initial_commit_hash": "dc7bdb934a2f1bba88d19136ff5caa6ff789dda7",
      "branch_name": "PvpTournament.BattleSnake.250915203207.sonnet-4-more-prescriptive",
      "round_tags": {}
    },
    {
      "name": "gpt-5-mini-default",
      "player_unique_id": "646cdd66-7cd5-4318-988f-3858ef3bd860",
      "created_timestamp": 1757982730,
      "config": {
        "agent": "mini",
        "name": "gpt-5-mini-default",
        "config": {
          "agent": {...},
          "model": {
            "model_name": "openai/gpt-5-mini"
          }
        }
      },
      "initial_commit_hash": "dc7bdb934a2f1bba88d19136ff5caa6ff789dda7",
      "branch_name": "PvpTournament.BattleSnake.250915203207.gpt-5-mini-default",
      "round_tags": {}
    }
  ]
}
```

## Application Structure

The application has two main pages:

1. **Game Picker** (`/picker`): A hierarchical tree view of all available game sessions
2. **Trajectory Viewer** (`/`): The main viewer for a selected game session

### Navigation

* The viewer has a "Pick Game" button that navigates to the picker
* The picker shows all game sessions in a tree structure with "Open" and "Open in new tab" buttons
* Navigation between pages happens in the same tab by default

### Keyboard Shortcuts

* `p` (lowercase): Open game picker in same tab (from viewer)
* `P` (uppercase): Open game picker in new tab (from viewer)
* `Ctrl/Cmd + D`: Toggle dark/light mode
* `Ctrl/Cmd + E`: Expand all sections
* `Ctrl/Cmd + Shift + E`: Collapse all sections
* `Escape`: Close all open sections

### Mouse Navigation

* **Left-click in checkbox column**: Toggle checkbox selection
* **Left-click elsewhere on game row**: Navigate to viewer in same tab
* **Middle-click on game row**: Open in new tab
* **Ctrl+click or Cmd+click on game row**: Open in new tab (alternative to middle-click)
* **Drag over checkbox column**: Multi-select games by dragging over checkboxes
* **Left-click on Open button**: Navigate to viewer in same tab
* **Middle-click on Open button**: Open in new tab
* **Ctrl+click or Cmd+click on Open button**: Open in new tab (alternative to middle-click)
* **Left-click on ‚Üó button**: Always open in new tab

## Game Picker Design (`/picker`)

### Features

* **Hierarchical Tree Structure**: Shows all folders recursively with proper indentation
* **Game Detection**: Any folder containing `metadata.json` is considered a game folder
* **Multi-Selection Support**: Checkboxes allow selecting multiple games for batch operations
* **Batch Actions**: Action dropdown with options like "Copy pathnames" for selected games
* **Readme Display**: Shows the first line of each game's `readme.txt` file in the table
* **Folder Collapse/Expand**: Click intermediate folders to minimize/expand their contents
  - Collapsed folders show üìÇ icon and blue accent border
  - Expanded folders show üìÅ icon
  - Children of collapsed folders are hidden
* **Visual Distinction**:
  - Game folders: üéÆ icon, clickable for selection, blue accent color
  - Intermediate folders: üìÅ/üìÇ icon, clickable to collapse, muted appearance
* **Tree Indentation**: Uses spaces and tree characters (‚îî‚îÄ) to show folder hierarchy
* **Round Count Display**: Shows number of rounds for each game session
* **Model Display**: Shows full model names without truncation
* **Selection Behavior**:
  - Click in checkbox column: Toggle checkbox selection
  - Drag over checkbox column: Multi-select games by dragging
  - Click elsewhere on game row: Navigate to viewer (supports middle-click)
  - "Open" button: Navigate to viewer (supports middle-click)
  - "‚Üó" button: Always open viewer in new tab
* **Batch Operations**:
  - "Select All" checkbox to toggle all games
  - Styled action dropdown with custom arrow and hover effects for batch operations on selected games
  - Copy pathnames copies selected game paths as space-separated string to clipboard

### Layout

* Full-width table structure with six columns: Select, Game Session, Note, Rounds, Models, Action
* Responsive design that adapts to mobile screens (hides some columns on mobile)
* Hover effects and visual feedback
* Base directory path display at the top
* Control bar with selection controls and action dropdown

## Trajectory Viewer Design (`/`)

### Header

* **"Pick Game" button**: Navigate to picker (supports middle-click for new tab)
  - Shows `p` keyboard shortcut indicator
  - Tooltip explains middle-click functionality
* **"‚Üó" button**: Always open picker in new tab
* **Dark/light mode toggle button**
* **Current folder path display** with copy functionality and delete button
  - **Delete button**: üóëÔ∏è icon with simple confirmation prompt to delete the entire experiment folder (rm -r)

### Main body

#### Readme Section

* **First section** after the header: A "Readme" section with editable text area
* Automatically loads content from `readme.txt` in the experiment folder (if it exists)
* **Autosave functionality**: Saves changes to `readme.txt` after 1 second of inactivity
* Shows status indicator: "Loading...", "Typing...", "Saving...", "Saved", "Error"
* Simple, unstyled text area for adding experiment notes and observations

#### Overall results

* At the top, we show the content of `metadata.json`
* There's a foldout that displays main.log (hidden by default)

#### Rounds

First, show a foldout of `round_1.log`.

Then, show a foldout with the trajectory view of player 1 round 1 (see below for trajectory view)
Then, show a foldout with the content of trajectory player 1 round 1 ["submission"]
Then, show a foldout with the content of trajectory player 1 round 1 ["memory"]
Then, show a foldout with the trajectory view of player 2 round 1 (see below for trajectory view).
Then, show a foldout with the content of trajectory player 2 round 1 ["submission"]
Then, show a foldout with the content of trajectory player 2 round 1 ["memory"]

Then, show a foldout of `round_2.log`.

Then, show a foldout with the trajectory view of player 1 round 2 (see below for trajectory view)
Then, show a foldout with the trajectory view of player 2 round 2 (see below for trajectory view).
Then, show a foldout with the content of trajectory player 2 round 2 ["submission"]
Then, show a foldout with the content of trajectory player 2 round 2 ["memory"]

etc.

Note that he last round only has the `round_n.log`, but there's no more trajectories for the last one.

#### Trajectory view

This should be its own jinja template.

First show the following properties from the `info` section

* Number of LM calls (api calls)
* Cost (instance cost)

Then, show all the messages. Each message should be its own block together with the role.
Because the content can be long, make sure to have a foldout for the content.

**Message Role Badges**: Each message displays a small role badge (e.g., "User #1", "Assistant #2") in the top-right corner. These badges automatically hide on hover over the message block to improve readability and allow users to see text that might be obscured by the badge.

### Important

* Always use the player name from the metadata.json file, do not assume players are called p1, p2, etc.
