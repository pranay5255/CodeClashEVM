<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeClash Trajectory Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>üéÆ CodeClash Trajectory Viewer</h1>

            <div class="controls">
                <!-- Folder Selection -->
                <div class="control-group">
                    <label for="folder-select">Game Session:</label>
                    <select id="folder-select" onchange="changeFolder()">
                        {% for folder in log_folders %}
                        <option value="{{ folder }}"
                                {% if folder == selected_folder %}selected{% endif %}>
                            {{ folder }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Dark Mode Toggle -->
                <div class="control-group">
                    <button id="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
                        <span class="theme-icon">üåô</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- Overall Results Section -->
        <section class="results-section">
            <h2>üìä Game Results</h2>

            <div class="metadata-display">
                <pre><code>{{ metadata.results | tojson(indent=2) }}</code></pre>
            </div>

            <!-- Main Log Foldout -->
            <details class="foldout">
                <summary>üìù Game Log</summary>
                <div class="log-content">
                    <pre><code>{{ metadata.main_log }}</code></pre>
                </div>
            </details>
        </section>

        <!-- Rounds Section -->
        <section class="rounds-section">
            <h2>üéØ Game Rounds</h2>

            {% for round_data in metadata.rounds %}
                {% set round_num = loop.index %}

                <!-- Round Log -->
                <details class="foldout round-foldout">
                    <summary>üéÆ Round {{ round_num }} Log</summary>
                    <div class="log-content">
                        <pre><code>{{ round_data.content }}</code></pre>
                    </div>
                </details>

                <!-- Player Trajectories for this round -->
                {% if round_num in trajectories_by_round %}
                    {% for trajectory in trajectories_by_round[round_num] %}

                        <!-- Trajectory Container with Overview and Messages -->
                        <div class="trajectory-header">
                            <h3>ü§ñ Player {{ trajectory.player_id }} Round {{ round_num }}</h3>
                            <div class="trajectory-stats">
                                <div class="stat-item">
                                    <span class="stat-label">API Calls:</span>
                                    <span class="stat-value">{{ trajectory.api_calls }}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Cost:</span>
                                    <span class="stat-value">${{ "%.2f"|format(trajectory.cost) }}</span>
                                </div>
                                {% if trajectory.exit_status %}
                                <div class="stat-item">
                                    <span class="stat-label">Exit Status:</span>
                                    <span class="stat-value status-{{ trajectory.exit_status.lower() }}">{{ trajectory.exit_status }}</span>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Messages Foldout inside the same container -->
                            <details class="trajectory-messages-foldout">
                                <summary>üí¨ Messages ({{ trajectory.messages|length }} total)</summary>
                                <div class="trajectory-content">
                                    <div class="messages-container">
                                        {% for message in trajectory.messages %}
                                    <div class="message-block {{ message.role }}">
                                        <span class="message-role-badge">{{ message.role.title() }} #{{ loop.index }}</span>
                                        <div class="message-content">
                                            {% if message.content is string %}
                                                {% set content_lines = message.content.split('\n') %}
                                                {% if content_lines|length <= 5 %}
                                                    <!-- Show full content if 5 lines or less -->
                                                    <div class="message-content-full">
                                                            {% if message.role == 'assistant' and '```' in message.content %}
                                                                <!-- Special handling for assistant messages with code blocks -->
                                                                {% set parts = message.content.split('```') %}
                                                                {% for part in parts %}
                                                                    {% if loop.index is odd %}
                                                                        <!-- Text part -->
                                                                        <div class="message-text"><pre>{{ part }}</pre></div>
                                                                    {% else %}
                                                                        <!-- Code part -->
                                                                        <div class="code-block">
                                                                            <pre><code>{{ part }}</code></pre>
                                                                        </div>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            {% else %}
                                                                <!-- Regular text content -->
                                                                <div class="message-text">
                                                                    <pre>{{ message.content }}</pre>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    {% else %}
                                                    <!-- Show preview with expand button -->
                                                    <div class="message-preview-short clickable-message" onclick="expandMessage(this)" title="Click to expand ({{ content_lines|length - 5 }} more lines)">
                                                            <div class="message-text">
                                                                <pre>{{ content_lines[:5] | join('\n') }}</pre>
                                                            </div>
                                                            <div class="expand-indicator">
                                                                ‚ñº {{ content_lines|length - 5 }} more lines
                                                            </div>
                                                    </div>
                                                    <div class="message-content-full" style="display: none;" title="Content expanded - click collapse button below to hide">
                                                            {% if message.role == 'assistant' and '```' in message.content %}
                                                                <!-- Special handling for assistant messages with code blocks -->
                                                                {% set parts = message.content.split('```') %}
                                                                {% for part in parts %}
                                                                    {% if loop.index is odd %}
                                                                        <!-- Text part -->
                                                                        <div class="message-text"><pre>{{ part }}</pre></div>
                                                                    {% else %}
                                                                        <!-- Code part -->
                                                                        <div class="code-block">
                                                                            <pre><code>{{ part }}</code></pre>
                                                                        </div>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            {% else %}
                                                                <!-- Regular text content -->
                                                                <div class="message-text">
                                                                    <pre>{{ message.content }}</pre>
                                                                </div>
                                                            {% endif %}
                                                            <div class="collapse-indicator clickable-message" onclick="collapseMessage(this)" title="Click to collapse">
                                                                ‚ñ≤ Click to collapse
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% elif message.content is iterable %}
                                                    <!-- Handle complex content (e.g., user messages with multiple parts) -->
                                                    <div class="message-content-full">
                                                        {% for content_part in message.content %}
                                                            {% if content_part.type == 'text' %}
                                                                {% set content_lines = content_part.text.split('\n') %}
                                                                {% if content_lines|length <= 5 %}
                                                                    <div class="message-text">
                                                                        <pre>{{ content_part.text }}</pre>
                                                                    </div>
                                                                {% else %}
                                                                    <div class="message-preview-short clickable-message" onclick="expandMessage(this)" title="Click to expand ({{ content_lines|length - 5 }} more lines)">
                                                                        <div class="message-text">
                                                                            <pre>{{ content_lines[:5] | join('\n') }}</pre>
                                                                        </div>
                                                                        <div class="expand-indicator">
                                                                            ‚ñº {{ content_lines|length - 5 }} more lines
                                                                        </div>
                                                                    </div>
                                                                    <div class="message-content-expanded" style="display: none;" title="Content expanded - click collapse button below to hide">
                                                                        <div class="message-text">
                                                                            <pre>{{ content_part.text }}</pre>
                                                                        </div>
                                                                        <div class="collapse-indicator clickable-message" onclick="collapseMessage(this)" title="Click to collapse">
                                                                            ‚ñ≤ Click to collapse
                                                                        </div>
                                                                    </div>
                                                                {% endif %}
                                                            {% else %}
                                                                <div class="message-part">
                                                                    <strong>{{ content_part.type.title() }}:</strong>
                                                                    <pre>{{ content_part | tojson(indent=2) }}</pre>
                                                                </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <!-- Fallback for other content types -->
                                                    <div class="message-content-full">
                                                        <div class="message-text">
                                                            <pre>{{ message.content | tojson(indent=2) }}</pre>
                                                        </div>
                                                    </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                        {% endfor %}
                                    </div>
                                    <div class="collapse-messages-button">
                                        <button onclick="collapseTrajectoryMessages(this)" class="btn-collapse-messages">
                                            ‚ñ≤ Collapse Messages
                                        </button>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <!-- Submission -->
                        {% if trajectory.submission %}
                        <details class="foldout">
                            <summary>üì§ Player {{ trajectory.player_id }} Round {{ round_num }} - Submission</summary>
                            <div class="log-content">
                                <pre><code>{{ trajectory.submission }}</code></pre>
                            </div>
                        </details>
                        {% endif %}

                        <!-- Memory -->
                        {% if trajectory.memory %}
                        <details class="foldout">
                            <summary>üß† Player {{ trajectory.player_id }} Round {{ round_num }} - Memory</summary>
                            <div class="log-content">
                                <pre><code>{{ trajectory.memory }}</code></pre>
                            </div>
                        </details>
                        {% endif %}

                    {% endfor %}
                {% endif %}

            {% endfor %}
        </section>
    </main>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
