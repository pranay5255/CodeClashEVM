<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeClash Trajectory Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://unpkg.com/jsoneditor@latest/dist/jsoneditor.min.css" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>üéÆ CodeClash Trajectory Viewer</h1>

            <div class="controls">
                <!-- Game Selection Buttons -->
                <div class="control-group">
                    <button id="pick-game-btn" class="pick-game-button" title="Pick Game (Press p) - Middle-click or Ctrl+click for new tab">
                        üéÆ Pick Game <kbd>p</kbd>
                    </button>
                    <button id="pick-game-new-tab-btn" class="pick-game-new-tab-button" title="Pick Game in New Tab (Press P)">
                        ‚Üó
                    </button>
                </div>

                <!-- Dark Mode Toggle -->
                <div class="control-group">
                    <button id="theme-toggle" aria-label="Toggle dark mode">
                        <span class="theme-icon">üåô</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- Current Folder Path -->
        <section class="folder-path-section">
            <div class="folder-path-container">
                <h3>üìÅ Current Folder:</h3>
                <div class="path-display">
                    <code class="folder-path">{{ selected_folder_path }}</code>
                    <button class="copy-path-btn" data-path="{{ selected_folder_path }}" title="Copy folder path">
                        üìã Copy path
                    </button>
                    <button class="delete-experiment-btn" data-folder-path="{{ selected_folder_path }}" title="Delete this experiment">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
        </section>

        <!-- Readme Section -->
        <section class="readme-section">
            <h2>üìù Readme</h2>
            <div class="readme-container">
                <textarea id="readme-textarea" class="readme-textarea" placeholder="Add notes about this experiment..."></textarea>
                <div class="readme-status" id="readme-status">Loading...</div>
            </div>
        </section>

        <!-- Setup Section -->
        <section class="setup-section">
            <h2>‚öôÔ∏è Setup</h2>

            <!-- Agent Information -->
            <div class="agent-info">
                {% if metadata.agent_info %}
                    <div class="agents-grid">
                        {% for agent in metadata.agent_info %}
                            <div class="agent-card">
                                <div class="agent-name">{{ agent.name }}</div>
                                {% if agent.model_name %}
                                    <div class="agent-model">Model: {{ agent.model_name }}</div>
                                {% endif %}
                                {% if agent.agent_class %}
                                    <div class="agent-class">Class: {{ agent.agent_class }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>No agent information available</p>
                {% endif %}
            </div>

            <!-- Metadata Foldout -->
            <details class="foldout">
                <summary>
                    üìã Metadata
                    {% if metadata.metadata_file_path %}
                    <button class="copy-path-btn-small" data-path="{{ metadata.metadata_file_path }}" title="Copy metadata file path">
                        üìã Copy path
                    </button>
                    {% endif %}
                </summary>
                <div class="metadata-display">
                    <div id="metadata-jsoneditor" class="json-viewer"></div>
                </div>
            </details>

            <!-- Main Log Foldout -->
            <details class="foldout">
                <summary>
                    üìù Tournament Log
                    {% if metadata.main_log_path %}
                    <button class="copy-path-btn-small" data-path="{{ metadata.main_log_path }}" title="Copy file path">
                        üìã Copy path
                    </button>
                    {% endif %}
                </summary>
                <div class="log-content">
                    <pre><code>{{ metadata.main_log }}</code></pre>
                </div>
            </details>
        </section>

        <!-- Overview Section -->
        <section class="overview-section">
            <h2>üìä Overview</h2>

            <div class="overview-summary">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Round</th>
                            <th>Winner</th>
                            <th>Results</th>
                            {% for trajectory in trajectories_by_round.get(1, []) %}
                                <th>Player {{ trajectory.player_id }} Steps</th>
                            {% endfor %}
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for round_data in metadata.rounds %}
                            <tr>
                                <td>{{ round_data.round_num }}</td>
                                <td>
                                    {% if round_data.results and round_data.results.winner %}
                                        <span class="winner-badge">{{ round_data.results.winner }}</span>
                                        {% if round_data.results.winner_percentage %}
                                            <span class="winner-percentage">({{ round_data.results.winner_percentage }}%)</span>
                                        {% endif %}
                                        {% if round_data.results.p_value is not none %}
                                            <span class="p-value">(p={{ "%.2f"|format(round_data.results.p_value) }})</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="no-result">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if round_data.results and round_data.results.sorted_scores %}
                                        <div class="score-breakdown">
                                            {% for player, score in round_data.results.sorted_scores %}
                                                <span class="score-item">{{ player }}: {{ score }}</span>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <span class="no-result">-</span>
                                    {% endif %}
                                </td>
                                {% if trajectories_by_round.get(round_data.round_num) %}
                                    {% for trajectory in trajectories_by_round[round_data.round_num] %}
                                        <td>
                                            <span class="steps-count">{{ trajectory.api_calls }}</span>
                                        </td>
                                    {% endfor %}
                                {% else %}
                                    {% for trajectory in trajectories_by_round.get(1, []) %}
                                        <td><span class="no-result">-</span></td>
                                    {% endfor %}
                                {% endif %}
                                <td>
                                    {% if metadata.agent_info %}
                                        <div class="models-cell">
                                            {% for agent in metadata.agent_info %}
                                                {% if agent.model_name %}
                                                    <span class="model-tag">{{ agent.model_name }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <span class="no-result">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="nav-to-round-btn" data-round="{{ round_data.round_num }}" title="Jump to Round {{ round_data.round_num }} details">
                                        <span class="nav-arrow">‚Üì</span>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Rounds Section -->
        <section class="rounds-section">
            <h2>üéØ Detailed Rounds</h2>

            {% for round_data in metadata.rounds %}
                {% set round_num = round_data.round_num %}

                <!-- Round Anchor for Navigation -->
                <div id="round-{{ round_num }}" class="round-anchor"></div>

                <!-- Player Trajectories for this round -->
                {% if round_num in trajectories_by_round %}
                    {% for trajectory in trajectories_by_round[round_num] %}

                        <!-- Trajectory Container with Overview and Messages -->
                        <div class="trajectory-header">
                            <h3>
                                ü§ñ Player {{ trajectory.player_id }} Round {{ round_num }}
                            </h3>
                            <div class="trajectory-stats">
                                <div class="stat-item">
                                    <span class="stat-label">API Calls:</span>
                                    <span class="stat-value">{{ trajectory.api_calls }}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Cost:</span>
                                    <span class="stat-value">${{ "%.2f"|format(trajectory.cost) }}</span>
                                </div>
                                {% if trajectory.exit_status %}
                                <div class="stat-item">
                                    <span class="stat-label">Exit Status:</span>
                                    <span class="stat-value status-{{ trajectory.exit_status.lower() }}">{{ trajectory.exit_status }}</span>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Messages Foldout inside the same container -->
                            <details class="trajectory-messages-foldout">
                                <summary>
                                    üí¨ Trajectory ({{ trajectory.messages|length }} total)
                                    {% if trajectory.trajectory_file_path %}
                                    <button class="copy-path-btn-small" data-path="{{ trajectory.trajectory_file_path }}" title="Copy trajectory file path">
                                        üìã Copy path
                                    </button>
                                    {% endif %}
                                </summary>
                                <div class="trajectory-content">
                                    <div class="messages-container">
                                        {% for message in trajectory.messages %}
                                    <div class="message-block {{ message.role }}">
                                        <span class="message-role-badge">{{ message.role.title() }} #{{ loop.index }}</span>
                                        <div class="message-content">
                                            {% if message.content is string %}
                                                {% set content_lines = message.content.split('\n') %}
                                                {% if content_lines|length <= 5 %}
                                                    <!-- Show full content if 5 lines or less -->
                                                    <div class="message-content-full">
                                                            {% if message.role == 'assistant' and '```' in message.content %}
                                                                <!-- Special handling for assistant messages with code blocks -->
                                                                {% set parts = message.content.split('```') %}
                                                                {% for part in parts %}
                                                                    {% if loop.index is odd %}
                                                                        <!-- Text part -->
                                                                        <div class="message-text"><pre>{{ part | unescape_content }}</pre></div>
                                                                    {% else %}
                                                                        <!-- Code part -->
                                                                        <div class="code-block">
                                                                            <pre><code>{{ part | unescape_content }}</code></pre>
                                                                        </div>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            {% else %}
                                                                <!-- Regular text content -->
                                                                <div class="message-text">
                                                                    <pre>{{ message.content | unescape_content }}</pre>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    {% else %}
                                                    <!-- Show preview with expand button -->
                                                    <div class="message-preview-short clickable-message"  title="Click to expand ({{ content_lines|length - 5 }} more lines)">
                                                            <div class="message-text">
                                                                <pre>{{ content_lines[:5] | join('\n') | unescape_content }}</pre>
                                                            </div>
                                                            <div class="expand-indicator">
                                                                ‚ñº {{ content_lines|length - 5 }} more lines
                                                            </div>
                                                    </div>
                                                    <div class="message-content-full" style="display: none;" title="Content expanded - click collapse button below to hide">
                                                            {% if message.role == 'assistant' and '```' in message.content %}
                                                                <!-- Special handling for assistant messages with code blocks -->
                                                                {% set parts = message.content.split('```') %}
                                                                {% for part in parts %}
                                                                    {% if loop.index is odd %}
                                                                        <!-- Text part -->
                                                                        <div class="message-text"><pre>{{ part | unescape_content }}</pre></div>
                                                                    {% else %}
                                                                        <!-- Code part -->
                                                                        <div class="code-block">
                                                                            <pre><code>{{ part | unescape_content }}</code></pre>
                                                                        </div>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            {% else %}
                                                                <!-- Regular text content -->
                                                                <div class="message-text">
                                                                    <pre>{{ message.content | unescape_content }}</pre>
                                                                </div>
                                                            {% endif %}
                                                            <div class="collapse-indicator clickable-message"  title="Click to collapse">
                                                                ‚ñ≤ Click to collapse
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% elif message.content is iterable %}
                                                    <!-- Handle complex content (e.g., user messages with multiple parts) -->
                                                    <div class="message-content-full">
                                                        {% for content_part in message.content %}
                                                            {% if content_part.type == 'text' %}
                                                                {% set content_lines = content_part.text.split('\n') %}
                                                                {% if content_lines|length <= 5 %}
                                                                    <div class="message-text">
                                                                        <pre>{{ content_part.text | unescape_content }}</pre>
                                                                    </div>
                                                                {% else %}
                                                                    <div class="message-preview-short clickable-message"  title="Click to expand ({{ content_lines|length - 5 }} more lines)">
                                                                        <div class="message-text">
                                                                            <pre>{{ content_lines[:5] | join('\n') | unescape_content }}</pre>
                                                                        </div>
                                                                        <div class="expand-indicator">
                                                                            ‚ñº {{ content_lines|length - 5 }} more lines
                                                                        </div>
                                                                    </div>
                                                                    <div class="message-content-expanded" style="display: none;" title="Content expanded - click collapse button below to hide">
                                                                        <div class="message-text">
                                                                            <pre>{{ content_part.text | unescape_content }}</pre>
                                                                        </div>
                                                                        <div class="collapse-indicator clickable-message"  title="Click to collapse">
                                                                            ‚ñ≤ Click to collapse
                                                                        </div>
                                                                    </div>
                                                                {% endif %}
                                                            {% else %}
                                                                <div class="message-part">
                                                                    <strong>{{ content_part.type.title() }}:</strong>
                                                                    <pre>{{ content_part | tojson(indent=2) }}</pre>
                                                                </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <!-- Fallback for other content types -->
                                                    <div class="message-content-full">
                                                        <div class="message-text">
                                                            <pre>{{ message.content | tojson(indent=2) }}</pre>
                                                        </div>
                                                    </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                        {% endfor %}
                                    </div>
                                    <div class="collapse-messages-button">
                                        <button class="btn-collapse-messages">
                                            ‚ñ≤ Collapse Messages
                                        </button>
                                    </div>
                                </div>
                            </details>

                            <!-- Diff Foldout inside the same container -->
                            {% if trajectory.diff_by_files and trajectory.diff_by_files %}
                            <details class="trajectory-messages-foldout">
                                <summary>üìù Diff (Full) ({{ trajectory.diff_by_files|length }} files)</summary>
                                <div class="trajectory-content">
                                    <div class="log-content">
                                        {% for file_path, file_diff in trajectory.diff_by_files.items() %}
                                        <details class="foldout">
                                            <summary>{{ file_path }}</summary>
                                            <div class="log-content">
                                                <pre><code>{{ file_diff }}</code></pre>
                                            </div>
                                        </details>
                                        {% endfor %}
                                    </div>
                                </div>
                            </details>
                            {% elif trajectory.diff and trajectory.diff.strip() %}
                            <details class="trajectory-messages-foldout">
                                <summary>üìù Diff (Full)</summary>
                                <div class="trajectory-content">
                                    <div class="log-content">
                                        <pre><code>{{ trajectory.diff }}</code></pre>
                                    </div>
                                </div>
                            </details>
                            {% endif %}

                            <!-- Incremental Diff Foldout inside the same container -->
                            {% if trajectory.incremental_diff_by_files and trajectory.incremental_diff_by_files %}
                            <details class="trajectory-messages-foldout">
                                <summary>üîÑ Incremental Diff ({{ trajectory.incremental_diff_by_files|length }} files)</summary>
                                <div class="trajectory-content">
                                    <div class="log-content">
                                        {% for file_path, file_diff in trajectory.incremental_diff_by_files.items() %}
                                        <details class="foldout">
                                            <summary>{{ file_path }}</summary>
                                            <div class="log-content">
                                                <pre><code>{{ file_diff }}</code></pre>
                                            </div>
                                        </details>
                                        {% endfor %}
                                    </div>
                                </div>
                            </details>
                            {% elif trajectory.incremental_diff and trajectory.incremental_diff.strip() %}
                            <details class="trajectory-messages-foldout">
                                <summary>üîÑ Incremental Diff</summary>
                                <div class="trajectory-content">
                                    <div class="log-content">
                                        <pre><code>{{ trajectory.incremental_diff }}</code></pre>
                                    </div>
                                </div>
                            </details>
                            {% endif %}

                            <!-- Modified Files Foldout inside the same container -->
                            {% if trajectory.modified_files and trajectory.modified_files %}
                            <details class="trajectory-messages-foldout">
                                <summary>üìÅ Changed Files ({{ trajectory.modified_files|length }} files)</summary>
                                <div class="trajectory-content">
                                    <div class="log-content">
                                        {% for file_path, file_content in trajectory.modified_files.items() %}
                                        <details class="foldout">
                                            <summary>{{ file_path }}</summary>
                                            <div class="log-content">
                                                <pre><code>{{ file_content }}</code></pre>
                                            </div>
                                        </details>
                                        {% endfor %}
                                    </div>
                                </div>
                            </details>
                            {% endif %}

                        </div>


                        <!-- Submission -->
                        {% if trajectory.submission %}
                        <details class="foldout">
                            <summary>üì§ Player {{ trajectory.player_id }} Round {{ round_num }} - Submission</summary>
                            <div class="log-content">
                                <pre><code>{{ trajectory.submission }}</code></pre>
                            </div>
                        </details>
                        {% endif %}

                        <!-- Memory -->
                        {% if trajectory.memory %}
                        <details class="foldout">
                            <summary>üß† Player {{ trajectory.player_id }} Round {{ round_num }} - Memory</summary>
                            <div class="log-content">
                                <pre><code>{{ trajectory.memory }}</code></pre>
                            </div>
                        </details>
                        {% endif %}

                    {% endfor %}
                {% endif %}

                <!-- Round Simulation Logs -->
                <details class="foldout round-foldout">
                    <summary>üéÆ Round {{ round_num }} Simulation Logs ({{ round_data.sim_logs|length }} sims)</summary>
                    <div class="log-content">
                        {% for sim_log in round_data.sim_logs %}
                        <details class="foldout sim-foldout">
                            <summary>
                                {{ sim_log.filename }}
                                <button class="copy-path-btn-small" data-path="{{ sim_log.full_path }}" title="Copy file path">
                                    üìã Copy path
                                </button>
                            </summary>
                            <div class="log-content">
                                <pre><code>{{ sim_log.content }}</code></pre>
                            </div>
                        </details>
                        {% endfor %}
                    </div>
                </details>

                <!-- Round Results (if available) -->
                {% if round_data.results %}
                <details class="foldout round-foldout">
                    <summary>
                        üèÜ Round {{ round_num }} Results
                        {% if round_data.results.winner and round_data.results.scores %}
                            {%- set total_games = round_data.results.scores.values() | sum -%}
                            {%- set winner = round_data.results.winner -%}
                            {%- if winner != 'Tie' -%}
                                {%- set winner_wins = round_data.results.scores.get(winner, 0) -%}
                                {%- set ties = round_data.results.scores.get('Tie', 0) -%}
                                {%- set win_percentage = ((winner_wins + 0.5 * ties) / total_games * 100) | round(1) -%}
                                - Winner: {{ winner }} with {{ win_percentage }}%
                                {%- if round_data.results.p_value is not none %} (p={{ "%.2f"|format(round_data.results.p_value) }}){% endif %} (
                                {%- for player, score in round_data.results.scores.items() -%}
                                    {{- score -}}
                                    {%- if not loop.last -%}-{%- endif -%}
                                {%- endfor -%})
                            {%- else -%}
                                - Winner: Tie
                                {%- if round_data.results.p_value is not none %} (p={{ "%.2f"|format(round_data.results.p_value) }}){% endif %} (
                                {%- for player, score in round_data.results.scores.items() -%}
                                    {{- score -}}
                                    {%- if not loop.last -%}-{%- endif -%}
                                {%- endfor -%})
                            {% endif %}
                        {% endif %}
                    </summary>
                    <div class="log-content">
                        <div id="round-{{ round_num }}-results-jsoneditor" class="json-viewer"></div>
                    </div>
                </details>
                {% endif %}

                <!-- Round separator (except after the last round) -->
                {% if not loop.last %}
                <div class="round-separator"></div>
                {% endif %}

            {% endfor %}
        </section>
    </main>

    <script src="https://unpkg.com/jsoneditor@latest/dist/jsoneditor.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/clipboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/experiment.js') }}"></script>
    <script src="{{ url_for('static', filename='js/readme.js') }}"></script>
    <script src="{{ url_for('static', filename='js/json-editors.js') }}"></script>
    <script>
        // Initialize all components when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Setup copy buttons
            setupCopyButtons();
            // Setup readme autosave
            setupReadmeAutosave();
            // Initialize JSON editors with metadata
            initializeJSONEditors({{ metadata | tojson | safe }});
        });
    </script>
</body>
</html>
