<!-- Trajectory Overview - always visible -->
<div class="trajectory-overview">
    <div class="trajectory-stats">
        <div class="stat-item">
            <span class="stat-label">API Calls:</span>
            <span class="stat-value">{{ trajectory.api_calls }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Cost:</span>
            <span class="stat-value">${{ "%.2f"|format(trajectory.cost) }}</span>
        </div>
        {% if trajectory.exit_status %}
        <div class="stat-item">
            <span class="stat-label">Exit Status:</span>
            <span class="stat-value status-{{ trajectory.exit_status.lower() }}">{{ trajectory.exit_status }}</span>
        </div>
        {% endif %}
    </div>
</div>

<!-- Messages Container - for foldout content -->
<div class="messages-container">
    {% for message in trajectory.messages %}
    <div class="message-block {{ message.role }}">
        <span class="message-role-badge">{{ message.role.title() }} #{{ loop.index }}</span>
        <div class="message-content">
            {% if message.content is string %}
                {% set content_lines = message.content.split('\n') %}
                {% if content_lines|length <= 5 %}
                    <!-- Show full content if 5 lines or less -->
                    <div class="message-content-full">
                            {% if message.role == 'assistant' and '```' in message.content %}
                                <!-- Special handling for assistant messages with code blocks -->
                                {% set parts = message.content.split('```') %}
                                {% for part in parts %}
                                    {% if loop.index is odd %}
                                        <!-- Text part -->
                                        <div class="message-text"><pre>{{ part }}</pre></div>
                                    {% else %}
                                        <!-- Code part -->
                                        <div class="code-block">
                                            <pre><code>{{ part }}</code></pre>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <!-- Regular text content -->
                                <div class="message-text">
                                    <pre>{{ message.content }}</pre>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                    <!-- Show preview with expand button -->
                    <div class="message-preview-short clickable-message" onclick="expandMessage(this)" title="Click to expand ({{ content_lines|length - 5 }} more lines)">
                            <div class="message-text">
                                <pre>{{ content_lines[:5] | join('\n') }}</pre>
                            </div>
                            <div class="expand-indicator">
                                ▼ {{ content_lines|length - 5 }} more lines
                            </div>
                    </div>
                    <div class="message-content-full" style="display: none;" title="Content expanded - click collapse button below to hide">
                            {% if message.role == 'assistant' and '```' in message.content %}
                                <!-- Special handling for assistant messages with code blocks -->
                                {% set parts = message.content.split('```') %}
                                {% for part in parts %}
                                    {% if loop.index is odd %}
                                        <!-- Text part -->
                                        <div class="message-text"><pre>{{ part }}</pre></div>
                                    {% else %}
                                        <!-- Code part -->
                                        <div class="code-block">
                                            <pre><code>{{ part }}</code></pre>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <!-- Regular text content -->
                                <div class="message-text">
                                    <pre>{{ message.content }}</pre>
                                </div>
                            {% endif %}
                            <div class="collapse-indicator clickable-message" onclick="collapseMessage(this)" title="Click to collapse">
                                ▲ Click to collapse
                            </div>
                        </div>
                    {% endif %}
                {% elif message.content is iterable %}
                    <!-- Handle complex content (e.g., user messages with multiple parts) -->
                    <div class="message-content-full">
                        {% for content_part in message.content %}
                            {% if content_part.type == 'text' %}
                                {% set content_lines = content_part.text.split('\n') %}
                                {% if content_lines|length <= 5 %}
                                    <div class="message-text">
                                        <pre>{{ content_part.text }}</pre>
                                    </div>
                                {% else %}
                                    <div class="message-preview-short clickable-message" onclick="expandMessage(this)" title="Click to expand ({{ content_lines|length - 5 }} more lines)">
                                        <div class="message-text">
                                            <pre>{{ content_lines[:5] | join('\n') }}</pre>
                                        </div>
                                        <div class="expand-indicator">
                                            ▼ {{ content_lines|length - 5 }} more lines
                                        </div>
                                    </div>
                                    <div class="message-content-expanded" style="display: none;" title="Content expanded - click collapse button below to hide">
                                        <div class="message-text">
                                            <pre>{{ content_part.text }}</pre>
                                        </div>
                                        <div class="collapse-indicator clickable-message" onclick="collapseMessage(this)" title="Click to collapse">
                                            ▲ Click to collapse
                                        </div>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="message-part">
                                    <strong>{{ content_part.type.title() }}:</strong>
                                    <pre>{{ content_part | tojson(indent=2) }}</pre>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <!-- Fallback for other content types -->
                    <div class="message-content-full">
                        <div class="message-text">
                            <pre>{{ message.content | tojson(indent=2) }}</pre>
                        </div>
                    </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
